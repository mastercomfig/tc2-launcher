<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Team Comtress Launcher</title>
    <style>
        * {
            box-sizing: border-box;
        }

        html {
            scrollbar-width: thin;
            scrollbar-color: rgb(0, 150, 136) rgb(33, 37, 41);
            scroll-padding-top: 89px;
            scroll-behavior: smooth;
            overflow-x: hidden;
            overflow-y: hidden;
            color-scheme: dark;
        }

        body {
            color-scheme: dark;
            background-color: rgb(33, 33, 33);
            color: rgb(222, 226, 230);
            font-family: "Roboto Flex Variable", -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 0.1px;
            line-height: 24px;
            margin: 0;
            text-align: start;
            overflow-x: hidden;
            overflow-y: hidden;
            height: 100vh;
            width: 100vw;
        }

        #logo-container {
            text-align: center;
            padding-top: 1rem;
            cursor: pointer;
        }

        #app {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }

        #launch-bar {
            display: flex;
            width: 100%;
            justify-content: center;
            padding: 1rem 1rem;
            background-color: rgb(255 255 255 / 5%);
            z-index: 10;
        }

        #news-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            width: 100%;
        }

        .logo {
            width: min(70vw, 400px);
            height: auto;
        }

        .btn {
            border: none;
            padding: 0.5rem 1rem;
            vertical-align: middle;
        }

        .btn:hover:not(:disabled) {
            cursor: pointer;
        }

        .btn-primary {
            background-color: rgb(0, 132, 120);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: rgb(0, 150, 136);
        }

        .btn-secondary {
            background-color: rgb(97, 97, 97);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: rgb(117, 117, 117);
        }

        .btn-lg {
            font-size: 1.25rem;
            padding: 0.75rem 1.5rem;
        }

        .spacer {
            flex-grow: 1;
        }

        .menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(33, 33, 33);
            color: rgb(222, 226, 230);
            padding-top: 1rem;
            overflow-y: auto;
            z-index: 5;
        }

        .menu-inner {
            width: 100%;
            padding: 0 2rem;
            max-height: calc(100% - 4.75rem);
            overflow: auto;
        }

        #launch-options {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .info-label {
            margin-right: 1rem;
            font-size: 1.25rem;
            vertical-align: middle;
            color: rgb(180, 180, 180);
        }

        #game-version-digest {
            font-size: 0.75rem;
            color: rgb(107, 107, 107);
            margin-left: 1rem;
            vertical-align: top;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="logo-container" title="News feed">
            <img src="tc2.png" class="logo" />
        </div>
        <div id="news-container">
            <iframe id="news-frame" src="about:blank" style="border: none; width: 100%; height: 100%; display: none"
                credentialless loading="lazy"></iframe>
            <div id="news-status" style="text-align: center;margin-top: -0.5rem;display: block"><strong>Fetching news
                    feed...</strong></div>
        </div>
        <div id="launch-bar">
            <div class="spacer"></div>
            <div class="game-menu">
                <span class="info-label show-offline" style="display: none">Offline mode</span>
                <button id="launch-btn" class="btn btn-primary btn-lg" disabled>Updating...</button>
                <button id="update-btn" class="btn btn-secondary btn-lg" title="Check for updates" disabled>
                    <svg width="24" height="20" viewBox="0 0 24 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M4.56079 10.6418L6.35394 3.94971L8.25402 5.84979C11.7312 3.6588 16.3814 4.07764 19.41 7.1063L17.9958 8.52052C15.7536 6.27827 12.3686 5.87519 9.71551 7.31128L11.2529 8.84869L4.56079 10.6418Z"
                            fill="currentColor" />
                        <path
                            d="M19.4392 13.3581L17.646 20.0502L15.7459 18.1501C12.2688 20.3411 7.61857 19.9223 4.58991 16.8936L6.00413 15.4794C8.24638 17.7217 11.6313 18.1247 14.2844 16.6887L12.747 15.1512L19.4392 13.3581Z"
                            fill="currentColor" />
                    </svg>
                </button>
                <button id="settings-btn" class="btn btn-secondary btn-lg" title="Settings">
                    <svg width="24" height="20" viewBox="0 0 24 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M7 3C8.86384 3 10.4299 4.27477 10.874 6H19V8H10.874C10.4299 9.72523 8.86384 11 7 11C4.79086 11 3 9.20914 3 7C3 4.79086 4.79086 3 7 3ZM7 9C8.10457 9 9 8.10457 9 7C9 5.89543 8.10457 5 7 5C5.89543 5 5 5.89543 5 7C5 8.10457 5.89543 9 7 9Z"
                            fill="currentColor" />
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M17 20C15.1362 20 13.5701 18.7252 13.126 17H5V15H13.126C13.5701 13.2748 15.1362 12 17 12C19.2091 12 21 13.7909 21 16C21 18.2091 19.2091 20 17 20ZM17 18C18.1046 18 19 17.1046 19 16C19 14.8954 18.1046 14 17 14C15.8954 14 15 14.8954 15 16C15 17.1046 15.8954 18 17 18Z"
                            fill="currentColor" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div id="settings-menu" class="menu">
        <div class="menu-inner">
            <h1>Settings</h1>
            <h2>Launch Options</h2>
            <input id="launch-options" type="text"></input>
            <h2>Install Folder</h2>
            <button id="open-folder-btn" class="btn btn-secondary" disabled>Browse Install Folder</button>
            <button id="move-folder-btn" class="btn btn-secondary" disabled>Move Install Folder</button>
            <h2>Updates</h2>
            <input id="prerelease" type="checkbox"></input>
            <label for="prerelease">Enable Pre-release Updates</label>
            <p style="font-size: 1rem;color: #888888">Pre-release updates are less tested, may contain more bugs, and
                cannot
                connect to official servers, but they provide access to newer features before they are officially
                released.
            </p>
            <p style="font-size: 1rem;color: #888888;margin-top: 1rem;margin-bottom: 0">Launcher version: <span
                    id="version">Unknown</span>
            </p>
            <p style="font-size: 1rem;color: #888888;margin-top: 0.2rem">Game version: <span
                    id="game-version">Unknown</span> <span id="game-version-digest"></span>
            </p>
        </div>
    </div>
    <script>
        let launchState = -1;
        let errCode = 0;
        let errLevel = 0;
        let online = true;
        let available = true;

        function getLaunchBtnText() {
            if (launchState === -1) {
                return "Updating...";
            }
            if (launchState === 1) {
                return "Launching..."
            }
            if (launchState === 2) {
                return "Running"
            }
            if (available) {
                return "Launch";
            } else {
                return "Install failed";
            }
        }

        function updateLaunchBtnText() {
            document.getElementById("launch-btn").innerText = getLaunchBtnText();
        }

        function updateLaunchBtnDisabled() {
            document.getElementById("launch-btn").disabled = launchState !== 0 || !available;
        }

        function updateUpdateBtnDisabled() {
            document.getElementById("update-btn").disabled = launchState !== 0;
        }

        function updatePrereleaseDisabled() {
            document.getElementById("prerelease").disabled = launchState !== 0;
        }

        function updateOpenFolderBtnDisabled() {
            document.getElementById("open-folder-btn").disabled = !available;
        }

        function updateMoveFolderBtnDisabled() {
            document.getElementById("move-folder-btn").disabled = launchState !== 0 || !available;
        }

        function updateAvailable() {
            available = launchState > -1 && errLevel <= 1;
        }

        function refreshOnline() {
            if (online) {
                document.querySelector(".show-offline").style.display = "none";
            } else {
                document.querySelector(".show-offline").style.display = "inline";
            }
        }

        function setErrCode(inErrCode) {
            // values
            errCode = inErrCode;
            errLevel = Math.abs(errCode);
            online = errCode <= 0;
            updateAvailable();
            // effects
            updateLaunchBtnText();
            updateLaunchBtnDisabled();
            updateOpenFolderBtnDisabled();
            updateMoveFolderBtnDisabled();
            refreshOnline();
        }

        function setLaunchState(state) {
            // values
            launchState = state;
            updateAvailable();
            // effects
            updateLaunchBtnText();
            updateLaunchBtnDisabled();
            updateUpdateBtnDisabled();
            updatePrereleaseDisabled();
            updateOpenFolderBtnDisabled();
            updateMoveFolderBtnDisabled();
        }

        function archiveReady(inErrCode) {
            setErrCode(inErrCode);
            setLaunchState(0);
        }

        async function queryWebApi(func, args) {
            return await fetch(`/api/${func}`, {
                method: "POST",
                body: args,
            });
        }

        class API {
            launch_game() {
                if (window.pywebview) {
                    window.pywebview.api.launch_game();
                } else {
                    queryWebApi("launch_game");
                }
            }

            set_launch_options(opts) {
                if (window.pywebview) {
                    window.pywebview.api.set_launch_options(opts);
                } else {
                    queryWebApi("set_launch_options", opts);
                }
            }

            open_install_folder() {
                if (window.pywebview) {
                    window.pywebview.api.open_install_folder();
                } else {
                    queryWebApi("open_install_folder");
                }
            }

            move_install_folder() {
                if (window.pywebview) {
                    window.pywebview.api.move_install_folder();
                } else {
                    queryWebApi("move_install_folder");
                }
            }

            check_for_updates() {
                if (window.pywebview) {
                    window.pywebview.api.check_for_updates();
                } else {
                    queryWebApi("check_for_updates");
                }
            }

            set_prerelease(branch) {
                if (window.pywebview) {
                    window.pywebview.api.set_prerelease(branch);
                } else {
                    queryWebApi("set_prerelease", branch);
                }
            }
        }

        const api = new API();

        document.getElementById("launch-btn").addEventListener("click", () => {
            if (document.getElementById("launch-btn").disabled) {
                return;
            }
            api.launch_game();
            setLaunchState(1);
        });
        document.getElementById("settings-btn").addEventListener("click", () => {
            if (document.getElementById("settings-btn").disabled) {
                return;
            }
            const menu = document.getElementById("settings-menu");
            if (menu.style.display === "block") {
                menu.style.display = "none";
            } else {
                menu.style.display = "block";
            }
        });
        document.getElementById("launch-options").addEventListener("input", (event) => {
            api.set_launch_options(event.target.value);
        });
        document.getElementById("open-folder-btn").addEventListener("click", () => {
            if (document.getElementById("open-folder-btn").disabled) {
                return;
            }
            api.open_install_folder();
        });
        document.getElementById("move-folder-btn").addEventListener("click", () => {
            if (document.getElementById("move-folder-btn").disabled) {
                return;
            }
            api.move_install_folder();
        });
        document.getElementById("update-btn").addEventListener("click", () => {
            if (document.getElementById("update-btn").disabled) {
                return;
            }
            setLaunchState(-1);
            api.check_for_updates();
        });
        document.getElementById("prerelease").addEventListener("change", (event) => {
            if (event.target.checked) {
                api.set_prerelease("prerelease");
            } else {
                api.set_prerelease("");
            }
            document.getElementById("update-btn").click();
        });

        let pumpTimeout = null;

        const launcherFeed = "https://teamcomtress.com/launcher_feed/";

        function tryLauncherFeed() {
            fetch(launcherFeed).then((r) => { if (r.ok) { return r; } else { throw new Error(`${r.status}${r.statusText ? ` ${r.statusText}` : ""}`); } }).then(() => {
                // double fetch, but what can we do?
                document.getElementById("news-frame").src = launcherFeed;
                document.getElementById("news-status").style.display = "none";
                document.getElementById("news-frame").style.display = "block";
            }).catch(err => {
                document.getElementById("news-status").innerHTML = `<strong>Failed to fetch news :(</strong> <br/> <code style="color: #ffaaaa;">${err}</code>`;
                console.error("Failed to fetch news:", err);
                document.getElementById("news-status").style.display = "block";
                document.getElementById("news-frame").style.display = "none";
            });
        }

        document.getElementById("logo-container").addEventListener("click", () => {
            tryLauncherFeed();
        });

        queryWebApi("state").then(d => d.json()).then(async state => {
            document.getElementById("launch-options").value = state.opts;
            document.getElementById("prerelease").checked = state.branch === "prerelease" ? true : false;
            document.getElementById("version").innerText = "v" + state.version;
            document.getElementById("game-version").innerText = state.game_version;
            document.getElementById("game-version-digest").innerText = state.game_version_digest;

            tryLauncherFeed();

            async function evalPump() {
                await queryWebApi("eval").then(d => d.json()).then(queue => {
                    for (const script of queue) {
                        eval(script);
                    }
                });
                pumpTimeout = setTimeout(evalPump, 500);
            }

            evalPump();
        }).catch(() => { console.log("Failed to get state from fallback API, assuming pywebview is available."); })

        function clearEvalPump() {
            if (pumpTimeout) {
                clearTimeout(pumpTimeout);
                pumpTimeout = null;
            }
        }

        window.addEventListener("beforeunload", () => {
            clearEvalPump();
        });

        window.addEventListener("pywebviewready", () => {
            document.getElementById("launch-options").value = window.pywebview?.state?.opts || "";
            document.getElementById("prerelease").checked = window.pywebview?.state?.branch === "prerelease" ? true : false;
            document.getElementById("version").innerText = "v" + window.pywebview?.state?.version || "";
            document.getElementById("game-version").innerText = window.pywebview?.state?.game_version || "";
            document.getElementById("game-version-digest").innerText = window.pywebview?.state?.game_version_digest || "";

            tryLauncherFeed();

            window.pywebview.state.addEventListener("change", event => {
                document.getElementById("launch-options").value = window.pywebview.state.opts;
                document.getElementById("prerelease").checked = window.pywebview.state.branch === "prerelease" ? true : false;
                document.getElementById("version").innerText = "v" + window.pywebview.state.version;
                document.getElementById("game-version").innerText = window.pywebview.state.game_version;
                document.getElementById("game-version-digest").innerText = window.pywebview.state.game_version_digest;
            })
        })
    </script>
</body>

</html>